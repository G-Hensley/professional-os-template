name: Skill Analysis Pipeline

on:
  schedule:
    # Weekly on Monday at 7 AM UTC (after activity log updates)
    - cron: '0 7 * * 1'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no PR created)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  analyze-skills:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Analyze skills across all repos
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: node .github/scripts/skill-analysis.js

      - name: Commit analysis report
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add logs/skill-analysis/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update skill analysis report (cross-repo scan)

            Weekly automated skill detection across all active repositories.

            ðŸ¤– Generated by GitHub Actions"
          fi

      - name: Check if PR needed
        id: check-pr
        run: |
          SUMMARY=$(cat /tmp/analysis-summary.json)
          HAS_CHANGES=$(echo "$SUMMARY" | node -e "const s=require('fs').readFileSync(0,'utf8');console.log(JSON.parse(s).has_changes)")
          REPOS_SCANNED=$(echo "$SUMMARY" | node -e "const s=require('fs').readFileSync(0,'utf8');console.log(JSON.parse(s).repos_scanned)")

          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          echo "repos_scanned=$REPOS_SCANNED" >> $GITHUB_OUTPUT
          echo "Has actionable changes: $HAS_CHANGES (scanned $REPOS_SCANNED repos)"

      - name: Create Pull Request
        if: steps.check-pr.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="skill-analysis-$(date +%Y-%m-%d)"
          git checkout -b "$BRANCH_NAME"
          git push -u origin "$BRANCH_NAME"

          REPORT=$(cat logs/skill-analysis/latest-analysis.json)
          DECAY_COUNT=$(echo "$REPORT" | node -e "const r=require('fs').readFileSync(0,'utf8');console.log(JSON.parse(r).skill_decay_warnings.length)")
          SUGGESTION_COUNT=$(echo "$REPORT" | node -e "const r=require('fs').readFileSync(0,'utf8');console.log(JSON.parse(r).suggestions.length)")
          SKILL_COUNT=$(echo "$REPORT" | node -e "const r=require('fs').readFileSync(0,'utf8');console.log(JSON.parse(r).skills_detected)")
          REPOS_SCANNED=${{ steps.check-pr.outputs.repos_scanned }}

          gh pr create \
            --title "Weekly Skill Analysis - $(date +%Y-%m-%d)" \
            --body "## Skill Analysis Report (Cross-Repo)

          Scanned **$REPOS_SCANNED repositories** from recent GitHub activity.

          ### Detection Sources
          - File extensions across all repos
          - package.json dependencies
          - Config folders (.claude, .codex, .github/workflows, etc.)

          ### Summary
          - **Skills detected**: $SKILL_COUNT
          - **Skill decay warnings**: $DECAY_COUNT (skills in profile but not detected)
          - **Suggestions**: $SUGGESTION_COUNT (heavily used skills)

          ### Next Steps
          1. Review \`logs/skill-analysis/latest-analysis.json\`
          2. Update \`profile/skills.json\` if needed
          3. Merge to track the analysis

          ---
          ðŸ¤– Generated by Skill Analysis Pipeline" \
            --base main

      - name: Push to main (if no PR needed)
        if: steps.check-pr.outputs.has_changes != 'true'
        run: |
          git push origin main || echo "Nothing to push"
